# 🔍 API测试指南

## 📋 概述

为了解决服务端同事的服务器部署问题，特别是用户登录时请求不到服务器用户数据和金币不能正常显示的问题，我们提供了多个测试脚本来诊断和验证API接口。

## 📁 测试脚本说明

### 1. **`quick-diagnosis.sh`** - 快速诊断脚本
- **用途**: 快速检查服务器基本状态
- **测试内容**: PM2服务状态、端口监听、数据库连接、API连通性、关键文件、日志
- **使用场景**: 初步排查服务器问题

### 2. **`test-login-issue.sh`** - 用户登录问题诊断脚本
- **用途**: 专门诊断用户登录和金币显示问题
- **测试内容**: 用户登录API、金币数据一致性、数据库验证
- **使用场景**: 解决用户登录和金币显示问题

### 3. **`test-user-login.sh`** - 用户登录详细测试脚本
- **用途**: 详细测试用户登录和数据获取流程
- **测试内容**: 登录、获取游戏数据、数据同步、验证
- **使用场景**: 全面测试用户登录相关功能

### 4. **`test-all-apis.sh`** - 全面API测试脚本
- **用途**: 测试所有关键API接口
- **测试内容**: 15个不同的API测试，包括用户、管理员、配置、支付等
- **使用场景**: 完整验证所有API功能

## 🚀 使用方法

### 方法一：快速诊断（推荐先运行）

```bash
# 1. 上传脚本到服务器
scp quick-diagnosis.sh user@your-server:/path/to/backend/

# 2. 登录服务器
ssh user@your-server

# 3. 进入目录
cd /path/to/backend

# 4. 执行快速诊断
./quick-diagnosis.sh
```

### 方法二：诊断登录问题

```bash
# 执行登录问题诊断
./test-login-issue.sh
```

### 方法三：全面API测试

```bash
# 执行全面API测试
./test-all-apis.sh
```

## 🔍 测试内容详解

### 快速诊断脚本检查项目

1. **PM2服务状态**
   - 检查 `boop-backend` 服务是否运行
   - 显示服务状态信息

2. **端口监听**
   - 检查端口3000是否正在监听
   - 显示监听状态

3. **数据库连接**
   - 测试数据库连接是否正常
   - 检查用户数量

4. **API连通性**
   - 测试API服务是否响应
   - 检查HTTP状态码

5. **关键文件**
   - 检查 `server.js`、`config.env`、`package.json` 是否存在

6. **日志检查**
   - 显示最新的日志信息
   - 帮助定位问题

### 登录问题诊断检查项目

1. **用户登录API测试**
   - 测试多个用户的登录
   - 验证登录响应格式

2. **金币数据一致性检查**
   - 比较API返回的金币与数据库中的金币
   - 检查 `users` 表和 `user_game_data` 表的一致性

3. **游戏数据API测试**
   - 测试获取用户游戏数据
   - 验证数据格式和内容

4. **管理员登录测试**
   - 测试管理员登录功能
   - 验证管理员权限

### 全面API测试检查项目

1. **服务器连通性**
2. **用户登录**
3. **管理员登录**
4. **获取用户游戏数据**
5. **同步用户数据**
6. **获取支付模式**
7. **设置支付模式**
8. **获取所有配置**
9. **获取用户信息**
10. **获取用户支付记录**
11. **获取所有支付记录**
12. **初始化用户游戏数据**
13. **数据库连接**
14. **PM2服务状态**
15. **端口监听**

## 📊 测试结果解读

### 成功状态
```
✅ 测试通过
🎉 所有测试通过！服务器运行正常。
```

### 失败状态
```
❌ 测试失败
⚠️  有 X 个测试失败，请检查服务器配置。
```

### 常见错误及解决方案

#### 1. PM2服务未运行
```bash
# 解决方案
pm2 start server.js --name boop-backend
pm2 save
```

#### 2. 数据库连接失败
```bash
# 检查数据库服务
systemctl status mysql

# 检查数据库用户
mysql -ugameuser -p123456 -e 'USE game_db;'

# 如果用户不存在，重新创建
mysql -u root -p < complete_database_backup.sql
```

#### 3. 端口未监听
```bash
# 检查防火墙
ufw status

# 检查端口占用
netstat -tlnp | grep 3000
```

#### 4. API返回错误
```bash
# 查看服务日志
pm2 logs boop-backend

# 检查配置文件
cat config.env
```

## 🔧 故障排除步骤

### 步骤1：快速诊断
```bash
./quick-diagnosis.sh
```

### 步骤2：根据诊断结果修复问题
- 如果PM2服务未运行：启动服务
- 如果数据库连接失败：检查数据库配置
- 如果端口未监听：检查防火墙和网络配置

### 步骤3：测试登录功能
```bash
./test-login-issue.sh
```

### 步骤4：全面验证
```bash
./test-all-apis.sh
```

## 📝 测试报告

每个测试脚本都会生成详细的测试报告，包括：

- **测试总数**: 总共执行的测试数量
- **通过测试**: 成功通过的测试数量
- **失败测试**: 失败的测试数量
- **详细日志**: 每个测试的详细输出
- **错误信息**: 失败原因和错误详情
- **修复建议**: 针对问题的解决建议

## 🛡️ 安全提醒

1. **测试环境**: 建议在测试环境中运行这些脚本
2. **敏感信息**: 脚本中包含测试用户密码，请在生产环境中修改
3. **日志清理**: 测试完成后清理测试日志
4. **权限控制**: 确保只有授权人员可以访问这些脚本

## 📞 技术支持

如果测试过程中遇到问题：

1. **查看详细日志**: `pm2 logs boop-backend`
2. **检查数据库**: `mysql -ugameuser -p123456 -e 'USE game_db;'`
3. **检查网络**: `ping 119.91.142.92`
4. **联系开发团队**: 提供测试结果和错误信息

---

**注意**: 这些测试脚本会向服务器发送实际的API请求，请确保在正确的环境中运行。 